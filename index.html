<!doctype html>
<html lang="en-US">

<head>
  <meta charset="utf-8" />
  <title>hello-wasm example</title>
  <style type="text/css">
    * {
      font-family: monospace;
    }

    .highlighted {
      background: rgb(165, 255, 188);
    }

    #view {
      word-break: break-all;
    }

    textarea {
      width: 80%;
      height: 5em;
    }

    button {
      font-size: 1.5em;
    }

    h2 {
      font-size: 1.2em;
      margin-bottom: 0em;
    }

    table tr>td:first-child {
      font-weight: bold;
      padding-right: 1em;
    }
  </style>
</head>

<body>
  <div id="container">
    <textarea
      placeholder="Enter payload as base64">AQAAAAAAAAAAAAAAAAAAAAACwj+3zkv2VM+aTfk60RqhXq6a/77WlLwu/BxXFkL7EppGsju/m8f0x5kBDD3EZTtGALGXlym5jnpZAoSIkswHoA==</textarea>
    <h1>Bytes</h1>
    <div id="view-bytes"></div>
    <div id="columns">
      <div id="view">
        <h1>Decoding</h1>
        <div id="view-decoded"></div>
      </div>
      <div id="explain">
        <h1>Explanation</h1>
        <h2>FLE1EncryptionPlaceholder (0)</h2>
        <table>
          <tr>
            <td>Created by</td>
            <td>mongocryptd / crypt_shared</td>
          </tr>
          <tr>
            <td>Intended for</td>
            <td>libmongocrypt</td>
          </tr>
          <tr>
            <td>References</td>
            <td><a
                href='https://github.com/mongodb/specifications/blob/9d0d3f0042a8cf5faeb47ae7765716151bfca9ef/source/bson-binary-encrypted/binary-encrypted.md'>Spec</a>
              <a
                href='https://github.com/mongodb/mongo/blob/6ec0bf4dd0c59fdfcacaaa36d3b7cb374da3e243/src/mongo/crypto/fle_field_schema.idl#L134-L159'>Server
                IDL</a> <a
                href='https://github.com/mongodb/libmongocrypt/blob/4e42cc36f2ff0cc059d5d49ae010d88fb6a82064/src/mongocrypt-marking.c#L47-L143'>libmongocrypt</a>
            </td>
          </tr>
          <tr>
            <td>Server Versions</td>
            <td>Added in 4.2</td>
          </tr>
        </table>
        <h2>FLE1DeterministicEncryptedValue (1)</h2>
        <table>
          <tr>
            <td>Created by</td>
            <td>libmongocrypt</td>
          </tr>
          <tr>
            <td>Intended for</td>
            <td>mongod / mongos</td>
          </tr>
          <tr>
            <td>References</td>
            <td><a
                href='https://github.com/mongodb/specifications/blob/9d0d3f0042a8cf5faeb47ae7765716151bfca9ef/source/bson-binary-encrypted/binary-encrypted.md'>Spec</a>
              <a
                href='https://github.com/mongodb/libmongocrypt/blob/4e42cc36f2ff0cc059d5d49ae010d88fb6a82064/src/mongocrypt-ciphertext-private.h#L24-L36'>libmongocrypt</a>
            </td>
          </tr>
          <tr>
            <td>Server Versions</td>
            <td>Added in 4.2</td>
          </tr>
        </table>
        <h2>FLE1RandomEncryptedValue (2)</h2>
        <table>
          <tr>
            <td>Created by</td>
            <td>libmongocrypt</td>
          </tr>
          <tr>
            <td>Intended for</td>
            <td>mongod / mongos</td>
          </tr>
          <tr>
            <td>References</td>
            <td><a
                href='https://github.com/mongodb/specifications/blob/9d0d3f0042a8cf5faeb47ae7765716151bfca9ef/source/bson-binary-encrypted/binary-encrypted.md'>Spec</a>
              <a
                href='https://github.com/mongodb/libmongocrypt/blob/4e42cc36f2ff0cc059d5d49ae010d88fb6a82064/src/mongocrypt-ciphertext-private.h#L24-L36'>libmongocrypt</a>
            </td>
          </tr>
          <tr>
            <td>Server Versions</td>
            <td>Added in 4.2</td>
          </tr>
        </table>
        <h2>FLE2EncryptionPlaceholder (3)</h2>
        <table>
          <tr>
            <td>Created by</td>
            <td>mongocryptd / crypt_shared</td>
          </tr>
          <tr>
            <td>Intended for</td>
            <td>libmongocrypt</td>
          </tr>
          <tr>
            <td>References</td>
            <td><a
                href='https://github.com/mongodb/mongo/blob/6ec0bf4dd0c59fdfcacaaa36d3b7cb374da3e243/src/mongo/crypto/fle_field_schema.idl#L161-L198'>Server
                IDL</a> <a
                href='https://github.com/mongodb/libmongocrypt/blob/4e42cc36f2ff0cc059d5d49ae010d88fb6a82064/src/mc-fle2-encryption-placeholder-private.h#L203-L228'>libmongocrypt</a>
            </td>
          </tr>
          <tr>
            <td>Server Versions</td>
            <td>Added in 4.2</td>
          </tr>
        </table>
        <h2>FLE2InsertUpdatePayload (4)</h2>
        <table>
          <tr>
            <td>Created by</td>
            <td>libmongocrypt</td>
          </tr>
          <tr>
            <td>Intended for</td>
            <td>mongocryptd / crypt_shared</td>
          </tr>
          <tr>
            <td>References</td>
            <td><a
                href='https://github.com/mongodb/mongo/blob/6ec0bf4dd0c59fdfcacaaa36d3b7cb374da3e243/src/mongo/crypto/fle_field_schema.idl#L161-L198'>Server
                IDL</a> <a
                href='https://github.com/mongodb/libmongocrypt/blob/4e42cc36f2ff0cc059d5d49ae010d88fb6a82064/src/mc-fle2-insert-update-payload-private.h#L27-L76'>libmongocrypt</a>
            </td>
          </tr>
          <tr>
            <td>Server Versions</td>
            <td>Added in 6.0. Removed in 7.0 (<a href='https://jira.mongodb.org/browse/SERVER-73303'>SERVER-73303</a>)
            </td>
          </tr>
        </table>

      </div>
    </div> <!-- #columns -->
  </div>
  <script type="module">
    import init, { decode } from "./pkg/iue_decoder.js";
    init().then(() => {
      let view_bytes = document.querySelector("#view-bytes");
      let view_decoded = document.querySelector("#view-decoded");
      let textarea = document.querySelector("textarea");

      function do_decode() {
        let bytes = atob(textarea.value);
        view_bytes.innerHTML = "";
        for (let i = 0; i < bytes.length; i++) {
          let byte = bytes.charCodeAt(i);
          const hex = byte.toString(16).toUpperCase().padStart(2, '0');
          view_bytes.innerHTML += `<span data-byte-index="${i}">${hex}</span>`;
        }

        let items = decode(textarea.value);
        let str = "<table>";
        items.forEach((item) => {
          str += `<tr><td>${item.key}</td><td data-start='${item.start}' data-end='${item.end}' data-id='${item.key}'>${item.val}`;
          str += "</td></tr>";
        });
        str += "</table>";
        view_decoded.innerHTML = str;
      }


      textarea.addEventListener("input", do_decode);

      view_decoded.addEventListener("mouseover", (e) => {
        if (!e.target.getAttribute("data-start")) {
          return;
        }

        // Remove existing highlights:
        document.querySelectorAll(".highlighted").forEach((el) => {
          el.classList.remove("highlighted");
        });

        // Highlight decoded element and byte span:
        e.target.classList.add("highlighted");
        const start = parseInt(e.target.getAttribute("data-start"));
        const end = parseInt(e.target.getAttribute("data-end"));
        for (let i = start; i < end; i++) {
          document.querySelector(`[data-byte-index="${i}"]`).classList.add("highlighted");
        }

      });

      do_decode();
    });

  </script>
</body>

</html>
